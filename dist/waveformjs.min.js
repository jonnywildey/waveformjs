/*! waveformjs - v0.0.1 - 2015-07-31
* https://github.com/jonnywildey/waveformjs
* Copyright (c) 2015 Jonny Wildey; Licensed MIT */
var drawsignal={canvas:null,pathSettings:{fill:"blue",stroke:"green",opacity:.5,fillRule:"evenodd"},outlineSettings:{fill:"",stroke:"grey",opacity:.5},playbackLine:null,playbackDelay:160,resolution:1,linearEasing:function(a,b,c,d){return c*a/d+b},strokeColors:["hsl(260, 90%, 70%)","hsl(200, 90%, 70%)","hsl(160, 90%, 70%)","hsl(100, 90%, 70%)","hsl(70, 90%, 70%)","hsl(60, 90%, 70%)","hsl(40, 90%, 70%)","hsl(20, 90%, 70%)"],fillColors:["hsl(205, 80%, 30%)","hsl(160, 80%, 30%)","hsl(110, 80%, 30%)","hsl(90, 80%, 30%)","hsl(70, 80%, 30%)","hsl(50, 80%, 30%)","hsl(30, 80%, 30%)","hsl(10, 80%, 30%)"],setupCanvas:function(a){fabric.Object.prototype.originX=fabric.Object.prototype.originY="center",this.canvas=a,this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas=new fabric.Canvas("canvas"),a.removeAll=function(){var b=a.getObjects();b.forEach(function(b){a.remove(b)})}},_player:null,setPlayer:function(a){this._player=a},getPlayer:function(){return this._player},signalToCircle:function(a,b,c){var d=this;c=c?c:100;var e=d.canvas,f=e.height,g=e.width,h=[.5*g,.5*f],i=f>g?h[0]:h[1],j=Math.pow(.5*Math.pow(i,2),.5);d.drawCircle(h,j),d.drawCircle(h,j-c),d.drawWaveCircle(h,j-.5*c,a,c,b);var k=[h[0],0,h[0],Math.pow(2*Math.pow(c,2),.5)];d.playbackLine=new fabric.Line(k,d.outlineSettings),d.canvas.add(d.playbackLine)},drawCircle:function(a,b){for(var c,d,e,f=[a[0]+b,a[1]+b],g="M "+f[0]+" "+f[1],h=0;b>h;h+=this.resolution)c=2*Math.PI*(h/b),d=Math.cos(c)*(f[0]-a[0])-Math.sin(c)*(f[1]-a[1])+a[0],e=Math.sin(c)*(f[0]-a[0])+Math.cos(c)*(f[1]-a[1])+a[1],g+="L "+d+" "+e;g+="L"+f[0]+" "+f[1];var i=new fabric.Path(g);i.set(this.outlineSettings),this.canvas.add(i)},drawWaveCircle:function(a,b,c,d,e){for(var f,g,h,i,j,k=this,l=c[0].length/b,m=[a[0]+b,a[1]+b],n="",o=0;o<c.length;o++)for(var p=0;b>p;p+=k.resolution)i=k.calculateVal(c[o],p,l),i=o%2?i:-1*i,j=[m[0]+i*d,m[1]+i*d],f=2*Math.PI*(p/b)-.75*Math.PI,g=Math.cos(f)*(j[0]-a[0])-Math.sin(f)*(j[1]-a[1])+a[0],h=Math.sin(f)*(j[0]-a[0])+Math.cos(f)*(j[1]-a[1])+a[1],n+="L "+g+" "+h;var q=new fabric.Path(n);q.set(k.pathSettings),k.canvas.add(q),k.rotateWave(q,e)},rotateWave:function(a,b){var c,d,e=this,f=0;e.getPlayer().on("progress",function(g){setTimeout(function(){var h=-a.angle/360*b-f;h=h/b*360*.5,d=g/b*360-h,d=d>360?360:d,c=g-f,a.animate("angle",""+-d,{onChange:e.canvas.renderAll.bind(e.canvas),duration:c,easing:e.linearEasing}),f=g},e.playbackDelay+5e-4*b)}),e.getPlayer().on("end",function(){a.animate("angle","-360",{onChange:e.canvas.renderAll.bind(e.canvas),duration:100,easing:e.linearEasing})})},signalToSpiral:function(a,b,c){var d=this,e=d.canvas,f=e.height,g=e.width,h=[.5*g,.5*f],i=f>g?h[0]:h[1],j=Math.pow(.5*Math.pow(i,2),.5);d.drawWaveSpiral(h,j-.5*c,a,c,b,18)},drawSpiral:function(a,b,c){for(var d,e=this,f=0,g="",h=0;b>h;h++)d=[],f-=c,d[0]=h,d[1]=e.getTheta(f,h,b),d=e.polarToCart(d),g+="L "+(d[0]+a[0])+" "+(d[1]+a[1]);var i=new fabric.Path(g);i.set(e.outlineSettings),e.canvas.add(i)},drawWaveSpiral:function(a,b,c,d,e,f){for(var g,h,i=this,j=c[0].length/b,k=([a[0]+b,a[1]+b],""),l=0,m=0;m<c.length;m++){l=0;for(var n=0;b>n;n+=i.resolution)h=i.calculateVal(c[m],b-n,j),h=m%2?h:-1*h,g=[],l-=f,g[0]=n-100*h,g[1]=i.getTheta(l,n,b),g=i.polarToCart(g),k+="L "+(g[0]+a[0])+" "+(g[1]+a[1])}var o=new fabric.Path(k);o.set(i.pathSettings),i.canvas.add(o)},getTheta:function(a,b,c){var d=(b-a)/c;return d},polarToCart:function(a){var b=[];return b[0]=a[0]*Math.cos(a[1]),b[1]=a[0]*Math.sin(a[1]),b},signalToCanvas:function(a,b){for(var c,d,e,f=this,g=this.canvas,h=g.height,i=g.width,j=.5*h,k=a[0].length/i,l=0;l<a.length;l++){var m="M 0 "+j;e=a[l];for(var n=0;i>n;n+=f.resolution)d=f.calculateVal(e,n,k),d=l%2?d:-1*d,c=j+d*h,m+="L "+n+" "+c;m+="L"+i+" "+j;var o=new fabric.Path(m);o.set(f.pathSettings),g.add(o)}f.drawPlaybackLine(b)},calculateVal:function(a,b,c){var d;return d=c>1?Math.abs(dsputil.windowedAmplitude(a,b*c,(b+1)*c)):dsputil.interpolateBuffer(a,b*c)},drawPlaybackLine:function(a){var b=this,c=1,d=b.getPlayer();d.on("progress",function(d){setTimeout(function(){b.writePlaybackLine(d,a,c),c=d},b.playbackDelay)})},playbackSettings:{fill:"black",stroke:"black",strokeWidth:1,opacity:.85,selectable:!1},writePlaybackLine:function(a,b,c){var d=this,e=this.canvas;e.remove(d.playbackLine);var f=e.height,g=e.width,h=a/b*g,i=[h,0,h,f],j=a-c,k=j/b*g;d.playbackLine=new fabric.Line(i,d.playbackSettings),d.canvas.add(d.playbackLine),d.playbackLine.animate("left","+="+k,{onChange:d.canvas.renderAll.bind(e),duration:j,easing:d.linearEasing})}},dsputil={interpolateBuffer:function(a,b){var c=Math.floor(b),d=Math.ceil(b),e=b-c,f=a[c],g=a[d],h=g-f;return h+g*e},averageAmplitude:function(a,b,c){for(var d,e=0,f=Math.floor(b),g=Math.ceil(c),h=f;g>h&&h<a.length;h++)d=a[h],e+=Math.abs(d);var i=e/(c-b);return i},windowedAmplitude:function(a,b,c){for(var d,e,f,g=0,h=Math.floor(b),i=Math.ceil(c),j=c-b,k=.5*j,l=h;i>l&&l<a.length;l++)d=a[l],f=l-h,e=k>f?f/k:(f-k)/k,g+=Math.abs(d)*e;var m=g/k;return m},splitArraysByChannel:function(a,b){for(var c=[],d=0;b>d;d++)c[d]=[];for(var d=0;b>d;d++)for(var e=0;e<a.length-1;e++)c[d].push(a[e+d]);return c}},fft={toComplex:function(a){var b=[];return a.forEach(function(a){b.push(math.complex(a))}),b},complexExp:function(a){var b=Math.exp(a.re),c=math.complex({re:Math.cos(a.im),im:b*Math.sin(a.im)});return c},complexMultiply:function(a,b){return math.complex({re:a.re*b.re-a.im*b.im,im:a.im*b.re+a.re*b.im})},complexAdd:function(a,b){return math.complex({re:a.re+b.re,im:a.im+b.im})},complexSubtract:function(a,b){return math.complex({re:a.re-b.re,im:a.im-b.im})},complexAbs:function(a){return Math.pow(a.re*a.re+a.im*a.im,2)},fftTransform:function(a,b,c){if(this.is2Exp(b)){for(var d,e=[],f=0;f<a.length-b;f+=b)d=this.cfft(a.slice(f,f+b)),e.push(this.normalise(d));return this.createMelWindow(e,26,b,c)}},melCepstrumTransfrom:function(a,b,c,d){var e=this.fftTransform(a,b,d);return this.createMelWindow(e,c,b,d)},cfft:function(a){var b=this,c=a.length;if(1>=c)return a;for(var d=.5*c,e=[],f=[],g=0;d>g;g++)e[g]=a[2*g],f[g]=a[2*g+1];e=b.cfft(e),f=b.cfft(f);for(var h=-2*Math.PI,g=0;d>g;g++){var i=g/c,j=b.complexExp(math.complex({re:0,im:h*i}));j=b.complexMultiply(j,f[g]),a[g]=b.complexAdd(j,e[g]),a[g+d]=b.complexSubtract(e[g],j)}return a},is2Exp:function(a){return 1===a?!0:math.floor(a)!==a?!1:this.is2Exp(a/2)},dct:function(a){for(var b,c=[],d=a.length,e=0;d>e;e++)b=Math.pow(Math.E,-1*e*Math.PI)/d*2,c[e]=b*a[e];return c},getFreqRow:function(a,b){for(var c=a/b,d=[],e=0;b/2>e;e++)d[e]=e*c;return d},hertzToMel:function(a){var b=.00142857142857*a+1;return 1127*Math.log(b)},melToHertz:function(a){var b=math.pow(10,.00038535645472*a)-1;return 700*b},createMelFilterBank:function(a,b,c){for(var d,e=[],f=this.hertzToMel(a),g=this.hertzToMel(b),h=(g-f)/c,i=0;c>i;i++)d=f+h*i,e.push(this.melToHertz(d));return e},freqToBins:function(a,b,c){var d=[],e=b+1;return a.forEach(function(a){d.push(Math.floor(e*(a/c)))}),d},windowFunction:function(a,b,c,d){var e=c[b[a-1]],f=c[b[a+1]],g=c[b[a]];return e>d?0:g>d?(d-e)/(g-e):f>d?(f-d)/(f-g):0},filterAmplitudes:function(a,b,c){for(var d,e,f=[],g=0;g<a.length;g++){d=a[g],e=0;for(var h=0;h<b.length;h++)e+=d*this.windowFunction(h,b,c,c[g]);e=Math.log(e),f.push(e)}return f},createMelWindow:function(a,b,c,d){var e,f=this,g=this.getFreqRow(d,c),h=this.createMelFilterBank(g[0],g[g.length-1],b),i=this.freqToBins(h,c,d),j=[];return a.forEach(function(a){e=f.filterAmplitudes(a,i,g),e=f.dct(e),j.push(e)}),j},normalise:function(a){for(var b=a.length,c=.5*b,d=[],e=0;c>e;e++)d[e]=Math.pow(this.complexAbs(a[e]),2)/b;return d}},waveformjs={asset:null,player:null,setup:function(a,b){drawsignal.setupCanvas(b),this.asset=AV.Asset.fromURL(a),this.player=AV.Player.fromURL(a),this.player.volume=20,drawsignal.setPlayer(this.player)},drawCircle:function(a,b){var c=this;c.setup(a,b),c.asset.decodeToBuffer(function(a){var b=c.asset.format.channelsPerFrame,d=dsputil.splitArraysByChannel(a,b);drawsignal.signalToCircle(d,c.asset.duration,100)})},drawSpiral:function(a,b){var c=this;c.setup(a,b),c.asset.decodeToBuffer(function(a){var b=c.asset.format.channelsPerFrame,d=dsputil.splitArraysByChannel(a,b);drawsignal.signalToSpiral(d,c.asset.duration,100),c.player.play()})},drawWave:function(a,b){var c=this;c.setup(a,b),c.asset.decodeToBuffer(function(a){var b=c.asset.format.channelsPerFrame,d=dsputil.splitArraysByChannel(a,b);drawsignal.signalToSpiral(d,c.asset.duration)})},drawFrequencies:function(a){for(var b=asset.format.channelsPerFrame,c=asset.format.sampleRate,d=1024,e=dsputil.splitArraysByChannel(a,b),f=fft.toComplex(e[0]),g=fft.frameCfft(f,d,c),h=0;5>h;h++){for(var i=[],j=0;j<g.length;j++)for(var k=0;d>k;k++)i.push(g[j][h]);drawsignal.pathSettings.stroke=strokeColors[h%strokeColors.length],drawsignal.pathSettings.fill=fillColors[h%fillColors.length],drawsignal.signalToCanvas(i,!0)}}};