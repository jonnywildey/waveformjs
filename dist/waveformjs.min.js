/*! waveformjs - v0.0.1 - 2015-08-19
* https://github.com/jonnywildey/waveformjs
* Copyright (c) 2015 Jonny Wildey; Licensed MIT */
var drawsignal={canvas:null,pathSettings:{fill:"blue",stroke:"green",opacity:.5,fillRule:"evenodd",selectable:!1},insideCircleSettings:{fill:"white",stroke:"grey",opacity:.45,fillRule:"evenodd",selectable:!1},spiralPlayheadSettings:{fill:"red",stroke:"",opacity:.25,width:30,height:30,selectable:!1},outlineSettings:{fill:"",stroke:"grey",opacity:.5,selectable:!1},playbackLine:null,player:null,playbackDelay:160,resolution:1,linearEasing:function(a,b,c,d){return c*a/d+b},strokeColors:["hsl(260, 90%, 70%)","hsl(200, 90%, 70%)","hsl(160, 90%, 70%)","hsl(100, 90%, 70%)","hsl(70, 90%, 70%)","hsl(60, 90%, 70%)","hsl(40, 90%, 70%)","hsl(20, 90%, 70%)"],fillColors:["hsl(205, 80%, 30%)","hsl(160, 80%, 30%)","hsl(110, 80%, 30%)","hsl(90, 80%, 30%)","hsl(70, 80%, 30%)","hsl(50, 80%, 30%)","hsl(30, 80%, 30%)","hsl(10, 80%, 30%)"],setupCanvas:function(a,b){fabric.Object.prototype.originX=fabric.Object.prototype.originY="center",this.canvas=a,this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas=new fabric.Canvas("canvas"),this.player=b,a.removeAll=function(){var b=a.getObjects();b.forEach(function(b){a.remove(b)})}},_player:null,setPlayer:function(a){this._player=a},getPlayer:function(){return this._player},signalToCircle:function(a,b,c){var d=this;c=c?c:100;var e=d.canvas,f=e.height,g=e.width,h=[.5*g,.5*f],i=f>g?h[0]:h[1],j=Math.pow(.5*Math.pow(i,2),.5);d.drawCircle(h,j),d.drawCircle(h,j-c),d.drawWaveCircle(h,j-.5*c,a,c,b);var k=[h[0],0,h[0],Math.pow(2*Math.pow(c,2),.5)];d.playbackLine=new fabric.Line(k,d.outlineSettings),d.canvas.add(d.playbackLine)},drawCircle:function(a,b,c){var d=this;c=c?c:d.outlineSettings;for(var e,f="",g=2*Math.PI,h=0;g>h;h+=.01)e=d.polarToCart(b,h,a),f+="L "+e[0]+" "+e[1];e=d.polarToCart(b,0,a),f+="L"+e[0]+" "+e[1];var i=new fabric.Path(f);i.set(c),this.canvas.add(i)},drawWaveCircle:function(a,b,c,d,e){for(var f,g,h,i,j,k=this,l=c[0].length/b,m=[a[0]+b,a[1]+b],n="",o=0;o<c.length;o++)for(var p=0;b>p;p+=k.resolution)i=k.calculateVal(c[o],p,l),i=o%2?i:-1*i,j=[m[0]+i*d,m[1]+i*d],f=2*Math.PI*(p/b)-.75*Math.PI,g=Math.cos(f)*(j[0]-a[0])-Math.sin(f)*(j[1]-a[1])+a[0],h=Math.sin(f)*(j[0]-a[0])+Math.cos(f)*(j[1]-a[1])+a[1],n+="L "+g+" "+h;var q=new fabric.Path(n);q.set(k.pathSettings),k.canvas.add(q),k.rotateWave(q,e)},rotateWave:function(a,b){var c,d,e=this,f=0;e.getPlayer().on("progress",function(g){setTimeout(function(){var h=-a.angle/360*b-f;h=h/b*360*.5,d=g/b*360-h,d=d>360?360:d,c=g-f,a.animate("angle",""+-d,{onChange:e.canvas.renderAll.bind(e.canvas),duration:c,easing:e.linearEasing}),f=g},e.playbackDelay+5e-4*b)}),e.getPlayer().on("end",function(){a.animate("angle","-360",{onChange:e.canvas.renderAll.bind(e.canvas),duration:100,easing:e.linearEasing})})},signalToSpiral:function(a,b,c){var d=this,e=d.canvas,f=e.height,g=e.width,h=[.5*g,.5*f],i=f>g?h[0]:h[1],j=Math.round(b/8e4);j=1>j?1:j;var k=i/5;d.drawWaveSpiral(h,k,.9*i,j,a,b)},drawSpiral:function(a,b,c,d,e,f){for(var g,h,i=this,j=(c-b)/d,k=j/(2*Math.PI),l=2*Math.PI*d,m="",n=0;l>n;n+=.01)h=b+k*n,g=i.polarToCart(h,n,a),m+="L "+g[0]+" "+g[1];var o=new fabric.Path(m);o.set(i.outlineSettings);var p=o.getWidth(),q=o.getHeight(),r=p>q?p:q,s=new fabric.Group([o],{left:a[0],top:a[1],width:r,height:r});o.set({left:.5*(p-q),top:.5*(q-p)}),i.canvas.add(s),i.drawCircle(a,b)},drawWaveSpiral:function(a,b,c,d,e,f){for(var g,h,i,j,k,l=this,m=(c-b)/d,n=m/(2>d?2:d)*.225,o=m/(2*Math.PI),p=l.lengthOfSpiral(b,o,d),q=.01,r=e[0].length/(c-b),s=2*Math.PI*d,t=e[0],u="",v=0;s>=v;v+=q)j=(s-v)/s*p,i=l.calculateVal(t,j,r),k=n/(v/s),h=b+(o-i*k)*v,g=l.polarToCart(h,v,a),u+="L "+g[0]+" "+g[1];t=e[1];for(var v=s;v>=0;v-=q)j=(s-v)/s*p,i=l.calculateVal(t,j,r),k=n/(v/s),h=b+(o+i*k)*v,g=l.polarToCart(h,v,a),u+="L "+g[0]+" "+g[1];var w=new fabric.Path(u),x=w.getWidth(),y=w.getHeight(),z=x>y?x:y,A=new fabric.Group([w],{left:a[0],top:a[1],width:z,height:z,selectable:!1});w.set({left:.5*(x-y),top:.5*(y-x)}),w.set(l.pathSettings),l.canvas.add(A),l.drawCircle(a,b,l.insideCircleSettings),l.drawPlaybackTriangle(b,a),l.drawSpiralPlaybackLine(f,c,b,d,a,x/y),l.rotateSpiralWave(A,f,d)},polarToCart:function(a,b,c){var d=[];return d[0]=a*Math.cos(b)+c[0],d[1]=a*Math.sin(b)+c[1],d},lengthOfSpiral:function(a,b,c){var d=function(a,b,c){return Math.pow(Math.pow(a+b*c,2)+Math.pow(b,2),.5)};return d(a,b,c*Math.PI*2)-d(a,b,0)},drawSpiralPlaybackLine:function(a,b,c,d,e,f){var g=this,h=1,i=g.getPlayer();i.on("progress",function(i){setTimeout(function(){g.writeSpiralPlaybackLine(i,a,h,b,c,d,e,f),h=i},2*g.playbackDelay)})},drawPlaybackTriangle:function(a,b){var c=.5*a,d=this,e=new fabric.Triangle({fill:"",stroke:"grey",opacity:.65,width:c,height:c,left:b[0],top:b[1],angle:90});e.on("selected",function(){d.player.play(),d.canvas.remove(e),d.drawPlaybackPause(a,b)}),this.canvas.add(e)},drawPlaybackPause:function(a,b){var c=.5*a,d=this,e=new fabric.Rect({fill:"",stroke:"grey",opacity:.65,width:.2*c,height:c,left:0,top:0}),f=new fabric.Rect({fill:"",stroke:"grey",opacity:.65,width:.2*c,height:c,left:.5*c,top:0}),g=new fabric.Group([e,f],{width:c,height:c,left:b[0],top:b[1]});g.on("selected",function(){d.player.pause(),d.canvas.remove(g),d.drawPlaybackTriangle(a,b)}),this.canvas.add(g)},writeSpiralPlaybackLine:function(a,b,c,d,e,f,g,h){var i=this,j=this.canvas;j.remove(i.playbackLine);var k=a/b*(d-e),l=i.polarToCart(d-k,0,g),m=new fabric.Triangle($.extend({left:l[0],top:l[1]},i.spiralPlayheadSettings));i.playbackLine=m;var n=a-c,o=n/b*(d-e);i.canvas.add(i.playbackLine),i.playbackLine.animate("left","-="+o,{onChange:i.canvas.renderAll.bind(j),duration:n,easing:i.linearEasing}),c=a},rotateSpiralWave:function(a,b,c){var d=this;b/=c;var e,f,g=0;d.getPlayer().on("progress",function(c){setTimeout(function(){var h=a.angle/360*b-g;h=h/b*360*.5,f=c/b*360-h,e=c-g,a.animate("angle",""+f,{onChange:d.canvas.renderAll.bind(d.canvas),duration:e,easing:d.linearEasing}),g=c},d.playbackDelay+3e-4*b)}),d.getPlayer().on("end",function(){a.animate("angle",""+360*c,{onChange:d.canvas.renderAll.bind(d.canvas),duration:100,easing:d.linearEasing})})},signalToCanvas:function(a,b){for(var c,d,e,f=this,g=this.canvas,h=g.height,i=g.width,j=.5*h,k=a[0].length/i,l=0;l<a.length;l++){var m="M 0 "+j;e=a[l];for(var n=0;i>n;n+=f.resolution)d=f.calculateVal(e,n,k),d=l%2?d:-1*d,c=j+d*h,m+="L "+n+" "+c;m+="L"+i+" "+j;var o=new fabric.Path(m);o.set(f.pathSettings),g.add(o)}f.drawPlaybackLine(b)},calculateVal:function(a,b,c){var d;return d=c>1?Math.abs(dsputil.windowedAmplitude(a,b*c,(b+1)*c)):dsputil.interpolateBuffer(a,b*c)},drawPlaybackLine:function(a){var b=this,c=1,d=b.getPlayer();d.on("progress",function(d){setTimeout(function(){b.writePlaybackLine(d,a,c),c=d},b.playbackDelay)})},playbackSettings:{fill:"black",stroke:"black",strokeWidth:1,opacity:.85,selectable:!1},writePlaybackLine:function(a,b,c){var d=this,e=this.canvas;e.remove(d.playbackLine);var f=e.height,g=e.width,h=a/b*g,i=[h,0,h,f],j=a-c,k=j/b*g;d.playbackLine=new fabric.Line(i,d.playbackSettings),d.canvas.add(d.playbackLine),d.playbackLine.animate("left","+="+k,{onChange:d.canvas.renderAll.bind(e),duration:j,easing:d.linearEasing})}},dsputil={interpolateBuffer:function(a,b){var c=Math.floor(b),d=Math.ceil(b),e=b-c,f=a[c],g=a[d],h=g-f;return h+g*e},averageAmplitude:function(a,b,c){for(var d,e=0,f=Math.floor(b),g=Math.ceil(c),h=f;g>h&&h<a.length;h++)d=a[h],e+=Math.abs(d);var i=e/(c-b);return i},windowedAmplitude:function(a,b,c){for(var d,e,f,g=0,h=Math.floor(b),i=Math.ceil(c),j=c-b,k=.5*j,l=h;i>l&&l<a.length;l++)d=a[l],f=l-h,e=k>f?f/k:(f-k)/k,g+=Math.abs(d)*e;var m=g/k;return m},splitArraysByChannel:function(a,b){for(var c=[],d=0;b>d;d++)c[d]=new Float32Array(.5*a.length);for(var d=0;b>d;d++)for(var e=0;e<a.length-1;e++)c[d][Math.floor(e/2)]=a[e+d];return c}},fft={toComplex:function(a){var b=[];return a.forEach(function(a){b.push(math.complex(a))}),b},complexExp:function(a){var b=Math.exp(a.re),c=math.complex({re:Math.cos(a.im),im:b*Math.sin(a.im)});return c},complexMultiply:function(a,b){return math.complex({re:a.re*b.re-a.im*b.im,im:a.im*b.re+a.re*b.im})},complexAdd:function(a,b){return math.complex({re:a.re+b.re,im:a.im+b.im})},complexSubtract:function(a,b){return math.complex({re:a.re-b.re,im:a.im-b.im})},complexAbs:function(a){return Math.pow(a.re*a.re+a.im*a.im,2)},fftTransform:function(a,b,c){if(this.is2Exp(b)){for(var d,e=[],f=0;f<a.length-b;f+=b)d=this.cfft(a.slice(f,f+b)),e.push(this.normalise(d));return this.createMelWindow(e,26,b,c)}},melCepstrumTransfrom:function(a,b,c,d){var e=this.fftTransform(a,b,d);return this.createMelWindow(e,c,b,d)},cfft:function(a){var b=this,c=a.length;if(1>=c)return a;for(var d=.5*c,e=[],f=[],g=0;d>g;g++)e[g]=a[2*g],f[g]=a[2*g+1];e=b.cfft(e),f=b.cfft(f);for(var h=-2*Math.PI,g=0;d>g;g++){var i=g/c,j=b.complexExp(math.complex({re:0,im:h*i}));j=b.complexMultiply(j,f[g]),a[g]=b.complexAdd(j,e[g]),a[g+d]=b.complexSubtract(e[g],j)}return a},is2Exp:function(a){return 1===a?!0:math.floor(a)!==a?!1:this.is2Exp(a/2)},dct:function(a){for(var b,c=[],d=a.length,e=0;d>e;e++)b=Math.pow(Math.E,-1*e*Math.PI)/d*2,c[e]=b*a[e];return c},getFreqRow:function(a,b){for(var c=a/b,d=[],e=0;b/2>e;e++)d[e]=e*c;return d},hertzToMel:function(a){var b=.00142857142857*a+1;return 1127*Math.log(b)},melToHertz:function(a){var b=math.pow(10,.00038535645472*a)-1;return 700*b},createMelFilterBank:function(a,b,c){for(var d,e=[],f=this.hertzToMel(a),g=this.hertzToMel(b),h=(g-f)/c,i=0;c>i;i++)d=f+h*i,e.push(this.melToHertz(d));return e},freqToBins:function(a,b,c){var d=[],e=b+1;return a.forEach(function(a){d.push(Math.floor(e*(a/c)))}),d},windowFunction:function(a,b,c,d){var e=c[b[a-1]],f=c[b[a+1]],g=c[b[a]];return e>d?0:g>d?(d-e)/(g-e):f>d?(f-d)/(f-g):0},filterAmplitudes:function(a,b,c){for(var d,e,f=[],g=0;g<a.length;g++){d=a[g],e=0;for(var h=0;h<b.length;h++)e+=d*this.windowFunction(h,b,c,c[g]);e=Math.log(e),f.push(e)}return f},createMelWindow:function(a,b,c,d){var e,f=this,g=this.getFreqRow(d,c),h=this.createMelFilterBank(g[0],g[g.length-1],b),i=this.freqToBins(h,c,d),j=[];return a.forEach(function(a){e=f.filterAmplitudes(a,i,g),e=f.dct(e),j.push(e)}),j},normalise:function(a){for(var b=a.length,c=.5*b,d=[],e=0;c>e;e++)d[e]=Math.pow(this.complexAbs(a[e]),2)/b;return d}},waveformjs={asset:null,player:null,setup:function(a,b){this.asset=AV.Asset.fromURL(a),this.player=AV.Player.fromURL(a),this.player.volume=20,drawsignal.setupCanvas(b,this.player),drawsignal.setPlayer(this.player)},drawCircle:function(a,b){var c=this;c.setup(a,b),c.asset.decodeToBuffer(function(a){var b=c.asset.format.channelsPerFrame,d=dsputil.splitArraysByChannel(a,b);drawsignal.signalToCircle(d,c.asset.duration,100),c.player.play()})},drawSpiral:function(a,b){var c=this;c.setup(a,b),c.asset.decodeToBuffer(function(a){var b=c.asset.format.channelsPerFrame,d=dsputil.splitArraysByChannel(a,b);drawsignal.signalToSpiral(d,c.asset.duration,100)})},drawWave:function(a,b){var c=this;c.setup(a,b),c.asset.decodeToBuffer(function(a){var b=c.asset.format.channelsPerFrame,d=dsputil.splitArraysByChannel(a,b);drawsignal.signalToSpiral(d,c.asset.duration),c.player.play()})},drawFrequencies:function(a){for(var b=asset.format.channelsPerFrame,c=asset.format.sampleRate,d=1024,e=dsputil.splitArraysByChannel(a,b),f=fft.toComplex(e[0]),g=fft.frameCfft(f,d,c),h=0;5>h;h++){for(var i=[],j=0;j<g.length;j++)for(var k=0;d>k;k++)i.push(g[j][h]);drawsignal.pathSettings.stroke=strokeColors[h%strokeColors.length],drawsignal.pathSettings.fill=fillColors[h%fillColors.length],drawsignal.signalToCanvas(i,!0)}}};