/*! waveformjs - v0.0.1 - 2015-07-26
* https://github.com/jonnywildey/waveformjs
* Copyright (c) 2015 Jonny Wildey; Licensed MIT */
var drawsignal={canvas:null,pathSettings:{fill:"blue",stroke:"green",opacity:.5,fillRule:"evenodd"},outlineSettings:{fill:"",stroke:"grey",opacity:.5},playbackLine:null,playbackDelay:160,resolution:1,setupCanvas:function(a){fabric.Object.prototype.originX=fabric.Object.prototype.originY="center",this.canvas=a,this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas=new fabric.Canvas("canvas"),a.removeAll=function(){var b=a.getObjects();b.forEach(function(b){a.remove(b)})}},signalToCircle:function(a,b,c){var d=this,e=d.canvas,f=e.height,g=e.width,h=[.5*g,.5*f],i=f>g?h[0]:h[1],j=Math.pow(.5*Math.pow(i,2),.5);d.drawCircle(h,j),d.drawCircle(h,j-c),d.drawWaveCircle(h,j-.5*c,a,amplitude,b);var k=[h[0],0,h[0],Math.pow(2*Math.pow(c,2),.5)];d.playbackLine=new fabric.Line(k,d.outlineSettings),d.canvas.add(d.playbackLine)},drawCircle:function(a,b,c){for(var d,e,f,g=[a[0]+b,a[1]+b],h="M "+g[0]+" "+g[1],i=0;b>i;i+=this.resolution)d=2*Math.PI*(i/b),e=Math.cos(d)*(g[0]-a[0])-Math.sin(d)*(g[1]-a[1])+a[0],f=Math.sin(d)*(g[0]-a[0])+Math.cos(d)*(g[1]-a[1])+a[1],h+="L "+e+" "+f;h+="L"+g[0]+" "+g[1];var j=new fabric.Path(h);j.set(this.outlineSettings),this.canvas.add(j)},drawWaveCircle:function(a,b,c,d,e){for(var f,g,h,i,j,k=this,l=c[0].length/b,m=[a[0]+b,a[1]+b],n="",o=0;o<c.length;o++)for(var p=0;b>p;p+=k.resolution)i=k.calculateVal(c[o],p,l),i=o%2?i:-1*i,j=[m[0]+i*d,m[1]+i*amp],f=2*Math.PI*(p/b)-.75*Math.PI,g=Math.cos(f)*(j[0]-a[0])-Math.sin(f)*(j[1]-a[1])+a[0],h=Math.sin(f)*(j[0]-a[0])+Math.cos(f)*(j[1]-a[1])+a[1],n+="L "+g+" "+h+" ";var q=new fabric.Path(n);q.set(k.pathSettings),rotateWave(q,e)},rotateWave:function(a,b){var c=this;c.canvas.add(a),setTimeout(function(){a.animate("angle","-360",{onChange:c.canvas.renderAll.bind(c.canvas),duration:b,easing:function(a,b,c,d){return c*a/d+b}})},c.playbackDelay)},signalToCanvas:function(a,b){for(var c,d,e=this.canvas,f=e.height,g=e.width,h=.5*f,i=a.length/g,j="M 0 "+h,k=0;g>k;k+=this.resolution)d=this.calculateVal(a,k,i),c=b?h-d*f:h+d*f,j+="L "+k+" "+c;j+="L"+g+" "+h;var l=new fabric.Path(j);l.set(this.pathSettings),e.add(l)},calculateVal:function(a,b,c){var d;return d=c>1?dsputil.averageAmplitude(a,b*c,(b+1)*c):dsputil.interpolateBuffer(a,b*c)},drawPlaybackLine:function(a,b){var c=this,d=1;a.on("progress",function(a){setTimeout(function(){c.writePlaybackLine(a,b,d),d=a},c.playbackDelay)})},playbackSettings:{fill:"black",stroke:"black",strokeWidth:1,opacity:.65,selectable:!1},writePlaybackLine:function(a,b,c){var d=this,e=this.canvas;e.remove(d.playbackLine);var f=e.height,g=e.width,h=a/b*g,i=[h,0,h,f],j=a-c,k=j/b*g;d.playbackLine=new fabric.Line(i,d.playbackSettings),d.canvas.add(d.playbackLine),d.playbackLine.animate("left","+="+k,{onChange:d.canvas.renderAll.bind(e),duration:j,easing:function(a,b,c,d){return c*a/d+b}})}},dsputil={interpolateBuffer:function(a,b){var c=Math.floor(b),d=Math.ceil(b),e=b-c,f=a[c],g=a[d],h=g-f;return h+g*e},averageAmplitude:function(a,b,c){for(var d,e=0,f=Math.floor(b),g=Math.ceil(c),h=f;g>h&&h<a.length;h++)d=a[h],e+=Math.abs(d);return e/(c-b)},splitArraysByChannel:function(a,b){for(var c=[],d=0;b>d;d++)c[d]=[];for(var d=0;d<a.length;d+=b)for(var e=0;b>e;e++)c[e].push(a[d+e]);return c}},fft={toComplex:function(a){var b=[];return a.forEach(function(a){b.push(math.complex(a))}),b},complexExp:function(a){var b=Math.exp(a.re),c=math.complex({re:Math.cos(a.im),im:b*Math.sin(a.im)});return c},complexMultiply:function(a,b){return math.complex({re:a.re*b.re-a.im*b.im,im:a.im*b.re+a.re*b.im})},complexAdd:function(a,b){return math.complex({re:a.re+b.re,im:a.im+b.im})},complexSubtract:function(a,b){return math.complex({re:a.re-b.re,im:a.im-b.im})},complexAbs:function(a){return Math.pow(a.re*a.re+a.im*a.im,2)},frameCfft:function(a,b,c){if(this.is2Exp(b)){for(var d,e=[],f=0;f<a.length-b;f+=b)d=this.cfft(a.slice(f,f+b)),e.push(this.normalise(d));return this.createMelWindow(e,26,b,c)}},cfft:function(a){var b=this,c=a.length;if(1>=c)return a;for(var d=.5*c,e=[],f=[],g=0;d>g;g++)e[g]=a[2*g],f[g]=a[2*g+1];e=b.cfft(e),f=b.cfft(f);for(var h=-2*Math.PI,g=0;d>g;g++){var i=g/c,j=b.complexExp(math.complex({re:0,im:h*i}));j=b.complexMultiply(j,f[g]),a[g]=b.complexAdd(j,e[g]),a[g+d]=b.complexSubtract(e[g],j)}return a},is2Exp:function(a){return 1===a?!0:math.floor(a)!==a?!1:this.is2Exp(a/2)},dct:function(a){for(var b,c=[],d=a.length,e=0;d>e;e++)b=Math.pow(Math.E,-1*e*Math.PI)/d*2,c[e]=b*a[e];return c},getFreqRow:function(a,b){for(var c=a/b,d=[],e=0;b/2>e;e++)d[e]=e*c;return d},hertzToMel:function(a){var b=.00142857142857*a+1;return 1127*Math.log(b)},melToHertz:function(a){var b=math.pow(10,.00038535645472*a)-1;return 700*b},getMelRow:function(a,b){var c=this,d=this.getFreqRow(a,b),e=[];return d.forEach(function(a){e.push(c.mel(a))}),e},createMelFilterBank:function(a,b,c){for(var d,e=[],f=this.hertzToMel(a),g=this.hertzToMel(b),h=(g-f)/c,i=0;c>i;i++)d=f+h*i,e.push(this.melToHertz(d));return e},freqToBins:function(a,b,c){var d=[],e=b+1;return a.forEach(function(a){d.push(Math.floor(e*(a/c)))}),d},windowFunction:function(a,b,c,d){var e=c[b[a-1]],f=c[b[a+1]],g=c[b[a]];return e>d?0:g>d?(d-e)/(g-e):f>d?(f-d)/(f-g):0},filterAmplitudes:function(a,b,c){for(var d,e,f=[],g=0;g<a.length;g++){d=a[g],e=0;for(var h=0;h<b.length;h++)e+=d*this.windowFunction(h,b,c,c[g]);e=Math.log(e),f.push(e)}return f},createMelWindow:function(a,b,c,d){var e,f=this,g=this.getFreqRow(d,c),h=this.createMelFilterBank(g[0],g[g.length-1],b),i=this.freqToBins(h,c,d),j=[];return a.forEach(function(a){e=f.filterAmplitudes(a,i,g),e=f.dct(e),j.push(e)}),j},normalise:function(a){for(var b=a.length,c=.5*b,d=[],e=0;c>e;e++)d[e]=Math.pow(this.complexAbs(a[e]),2)/b;return d}},waveformjs={run:function(a,b){drawsignal.setupCanvas(b);var c=AV.Asset.fromURL(a),d=AV.Player.fromURL(a),e=["hsl(260, 90%, 70%)","hsl(200, 90%, 70%)","hsl(160, 90%, 70%)","hsl(100, 90%, 70%)","hsl(70, 90%, 70%)","hsl(60, 90%, 70%)","hsl(40, 90%, 70%)","hsl(20, 90%, 70%)"],f=["hsl(205, 80%, 30%)","hsl(160, 80%, 30%)","hsl(110, 80%, 30%)","hsl(90, 80%, 30%)","hsl(70, 80%, 30%)","hsl(50, 80%, 30%)","hsl(30, 80%, 30%)","hsl(10, 80%, 30%)"];c.decodeToBuffer(function(a){g(a),d.play()}),d.on("ready",function(){});var g=function(a){var b=c.format.channelsPerFrame,d=dsputil.splitArraysByChannel(a,b);drawsignal.signalToCircle(d,c.duration)};drawFrequencies=function(a){for(var b=c.format.channelsPerFrame,d=c.format.sampleRate,g=1024,h=dsputil.splitArraysByChannel(a,b),i=fft.toComplex(h[0]),j=fft.frameCfft(i,g,d),k=0;5>k;k++){for(var l=[],m=0;m<j.length;m++)for(var n=0;g>n;n++)l.push(j[m][k]);drawsignal.pathSettings.stroke=e[k%e.length],drawsignal.pathSettings.fill=f[k%f.length],drawsignal.signalToCanvas(l,!0)}}}};