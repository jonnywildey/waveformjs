/*! waveformjs - v0.0.1 - 2015-07-25
* https://github.com/jonnywildey/waveformjs
* Copyright (c) 2015 Jonny Wildey; Licensed MIT */
var drawsignal={canvas:null,pathSettings:{fill:"blue",stroke:"green",opacity:.5},playbackLine:null,playbackDelay:140,resolution:1,setupCanvas:function(){var a=document.getElementById("canvas");a.width=window.innerWidth,a.height=window.innerHeight,canvas=new fabric.Canvas("canvas"),canvas.removeAll=function(){var a=canvas.getObjects();a.forEach(function(a){canvas.remove(a)})},this.canvas=canvas},signalToCanvas:function(a,b){for(var c,d,e=this.canvas,f=e.height,g=e.width,h=.5*f,i=a.length/g,j="M 0 "+h,k=0;g>k;k+=this.resolution)d=i>1?dsputil.averageAmplitude(a,k*i,(k+1)*i):dsputil.interpolateBuffer(a,k*i),c=b?h-d*f:h+d*f,j+="L "+k+" "+c;j+="L"+g+" "+h;var l=new fabric.Path(j);l.set(this.pathSettings),e.add(l)},drawPlaybackLine:function(a,b){var c=this,d=1;a.on("progress",function(a){setTimeout(function(){c.writePlaybackLine(a,b,d),d=a},c.playbackDelay)})},playbackSettings:{fill:"black",stroke:"black",strokeWidth:1,opacity:.65,selectable:!1},writePlaybackLine:function(a,b,c){var d=this;canvas.remove(d.playbackLine);var e=canvas.height,f=canvas.width,g=a/b*f,h=[g,0,g,e],i=a-c,j=i/b*f;d.playbackLine=new fabric.Line(h,d.playbackSettings),d.canvas.add(d.playbackLine),d.playbackLine.animate("left","+="+j,{onChange:d.canvas.renderAll.bind(canvas),duration:i,easing:function(a,b,c,d){return c*a/d+b}})}},dsputil={interpolateBuffer:function(a,b){var c=Math.floor(b),d=Math.ceil(b),e=b-c,f=a[c],g=a[d],h=g-f;return h+g*e},averageAmplitude:function(a,b,c){for(var d,e=0,f=Math.floor(b),g=Math.ceil(c),h=f;g>h&&h<a.length;h++)d=a[h],e+=Math.abs(d);return e/(c-b)},splitArraysByChannel:function(a,b){for(var c=[],d=0;b>d;d++)c[d]=[];for(var d=0;d<a.length;d+=b)for(var e=0;b>e;e++)c[e].push(a[d+e]);return c}},fft={toComplex:function(a){var b=[];return a.forEach(function(a){b.push(math.complex(a))}),b},complexExp:function(a){var b=Math.exp(a.re),c=math.complex({re:Math.cos(a.im),im:b*Math.sin(a.im)});return c},complexMultiply:function(a,b){return math.complex({re:a.re*b.re-a.im*b.im,im:a.im*b.re+a.re*b.im})},complexAdd:function(a,b){return math.complex({re:a.re+b.re,im:a.im+b.im})},complexSubtract:function(a,b){return math.complex({re:a.re-b.re,im:a.im-b.im})},complexAbs:function(a){return Math.pow(a.re*a.re+a.im*a.im,2)},frameCfft:function(a,b,c){if(this.is2Exp(b)){for(var d,e=[],f=0;f<a.length-b;f+=b)d=this.cfft(a.slice(f,f+b)),e.push(this.normalise(d));return this.createMelWindow(e,26,b,c)}},cfft:function(a){var b=this,c=a.length;if(1>=c)return a;for(var d=.5*c,e=[],f=[],g=0;d>g;g++)e[g]=a[2*g],f[g]=a[2*g+1];e=b.cfft(e),f=b.cfft(f);for(var h=-2*Math.PI,g=0;d>g;g++){var i=g/c,j=b.complexExp(math.complex({re:0,im:h*i}));j=b.complexMultiply(j,f[g]),a[g]=b.complexAdd(j,e[g]),a[g+d]=b.complexSubtract(e[g],j)}return a},is2Exp:function(a){return 1===a?!0:math.floor(a)!==a?!1:this.is2Exp(a/2)},dct:function(a){for(var b,c=[],d=a.length,e=0;d>e;e++)b=Math.pow(Math.E,-1*e*Math.PI)/d*2,c[e]=b*a[e];return c},getFreqRow:function(a,b){for(var c=a/b,d=[],e=0;b/2>e;e++)d[e]=e*c;return d},hertzToMel:function(a){var b=.00142857142857*a+1;return 1127*Math.log(b)},melToHertz:function(a){var b=math.pow(10,.00038535645472*a)-1;return 700*b},getMelRow:function(a,b){var c=this,d=this.getFreqRow(a,b),e=[];return d.forEach(function(a){e.push(c.mel(a))}),e},createMelFilterBank:function(a,b,c){for(var d,e=[],f=this.hertzToMel(a),g=this.hertzToMel(b),h=(g-f)/c,i=0;c>i;i++)d=f+h*i,e.push(this.melToHertz(d));return e},freqToBins:function(a,b,c){var d=[],e=b+1;return a.forEach(function(a){d.push(Math.floor(e*(a/c)))}),d},windowFunction:function(a,b,c,d){var e=c[b[a-1]],f=c[b[a+1]],g=c[b[a]];return e>d?0:g>d?(d-e)/(g-e):f>d?(f-d)/(f-g):0},filterAmplitudes:function(a,b,c){for(var d,e,f=[],g=0;g<a.length;g++){d=a[g],e=0;for(var h=0;h<b.length;h++)e+=d*this.windowFunction(h,b,c,c[g]);e=Math.log(e),f.push(e)}return f},createMelWindow:function(a,b,c,d){var e,f=this,g=this.getFreqRow(d,c),h=this.createMelFilterBank(g[0],g[g.length-1],b),i=this.freqToBins(h,c,d),j=[];return a.forEach(function(a){e=f.filterAmplitudes(a,i,g),e=f.dct(e),j.push(e)}),j},normalise:function(a){for(var b=a.length,c=.5*b,d=[],e=0;c>e;e++)d[e]=Math.pow(this.complexAbs(a[e]),2)/b;return d}},waveformjs={run:function(a){drawsignal.setupCanvas();var b=AV.Asset.fromURL(a),c=AV.Player.fromURL(a),d=["hsl(260, 90%, 70%)","hsl(200, 90%, 70%)","hsl(160, 90%, 70%)","hsl(100, 90%, 70%)","hsl(70, 90%, 70%)","hsl(60, 90%, 70%)","hsl(40, 90%, 70%)","hsl(20, 90%, 70%)"],e=["hsl(205, 80%, 30%)","hsl(160, 80%, 30%)","hsl(110, 80%, 30%)","hsl(90, 80%, 30%)","hsl(70, 80%, 30%)","hsl(50, 80%, 30%)","hsl(30, 80%, 30%)","hsl(10, 80%, 30%)"];c.play(),b.decodeToBuffer(function(a){f(a),c.play()}),c.on("ready",function(){drawsignal.drawPlaybackLine(c,b.duration)});var f=function(a){var c=b.format.channelsPerFrame,f=dsputil.splitArraysByChannel(a,c);f.forEach(function(a,b){drawsignal.pathSettings.stroke=d[b%d.length],drawsignal.pathSettings.fill=e[b%e.length],drawsignal.signalToCanvas(a,b%2)})};drawFrequencies=function(a){for(var c=b.format.channelsPerFrame,f=b.format.sampleRate,g=1024,h=dsputil.splitArraysByChannel(a,c),i=fft.toComplex(h[0]),j=fft.frameCfft(i,g,f),k=0;5>k;k++){for(var l=[],m=0;m<j.length;m++)for(var n=0;g>n;n++)l.push(j[m][k]);drawsignal.pathSettings.stroke=d[k%d.length],drawsignal.pathSettings.fill=e[k%e.length],drawsignal.signalToCanvas(l,!0)}}}};